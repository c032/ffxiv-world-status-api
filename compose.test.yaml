version: "3.8"

services:
  api-e2e:
    build:
      context: "."
      dockerfile: "Dockerfile-e2e"
    depends_on:
      postgresql:
        condition: "service_healthy"
    environment:
      - "POSTGRESQL_CONNECTION_STRING_FILE=/usr/local/etc/api.c032.dev/postgresql_connection_string_test"
      - "PORT=8000"
    links:
      - "postgresql:postgresql"
    volumes:
      - "./docker/postgresql_connection_string_test:/usr/local/etc/api.c032.dev/postgresql_connection_string_test"

  postgresql:
    build:
      context: "."
      dockerfile: "./docker/postgresql.dockerfile"
    environment:
      - "PGDATA=/var/lib/postgresql/data/pgdata"
      - "POSTGRES_DB=test_api_e2e"
      - "POSTGRES_HOST_AUTH_METHOD=scram-sha-256"
      - "POSTGRES_INITDB_ARGS=--no-locale --data-checksums --auth-host=scram-sha-256"
      - "POSTGRES_PASSWORD=correct horse battery staple"
      - "POSTGRES_USER=test_api_e2e"
    healthcheck:
      interval: "5s"
      retries: "5"
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      timeout: "5s"
    volumes:
      - "postgresql_data_test:/var/lib/postgresql/data/pgdata"

volumes:
  postgresql_data_test:
